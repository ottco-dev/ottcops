<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MQTT Sensors · OPENCORE Analyzer</title>
    <style>
      body {
        margin: 0 auto;
        max-width: 960px;
        padding: 2.5rem;
        font-family: "Space Grotesk", system-ui, sans-serif;
        line-height: 1.6;
      }
      a {
        color: #0d5c63;
      }
      code {
        background: #111527;
        color: #f7f8fb;
        padding: 0.15rem 0.35rem;
        border-radius: 4px;
      }
      pre {
        background: #0b1020;
        color: #f8fbff;
        padding: 1rem;
        border-radius: 12px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>MQTT sensors & prompt blocks</h1>
      <p>
        Connect greenhouse sensors to the analyzer so prompts can reference live humidity, temperature, CO₂, PPFD/LUX, EC, and pH values.
        Configure the broker in the config hub, then drag sensor chips into prompts on the main analyzer page.
      </p>
      <nav>
        <a href="/doc/index.html">Index</a>
      </nav>
    </header>

    <section>
      <h2>Setup</h2>
      <ol>
        <li>Open <code>/config</code> and scroll to <strong>MQTT sensors</strong>.</li>
        <li>Enter broker host/port plus optional username/password and TLS toggle.</li>
        <li>Add sensors with label, topic, kind (CO2, PPFD/LUX, humidity, temperature, EC, pH), and unit.</li>
        <li>Click <em>Save MQTT config</em> to persist server-side.</li>
        <li>Use <em>Test &amp; fetch values</em> to verify the broker and preview readings.</li>
      </ol>
    </section>

    <section>
      <h2>Using sensors in prompts</h2>
      <ul>
        <li>On <code>/</code> click <em>Refresh sensor values</em> to pull the latest readings.</li>
        <li>Drag a sensor chip onto the prompt textarea or click it to insert a text snippet such as <code>Humidity: 58%</code>.</li>
        <li>The inserted text becomes part of the prompt sent to the LLM, grounding plant-health or growth instructions in real metrics.</li>
      </ul>
    </section>

    <section>
      <h2>API endpoints</h2>
      <ul>
        <li><code>GET /api/mqtt/config</code> – returns stored broker + sensors (password omitted).</li>
        <li><code>POST /api/mqtt/config</code> – saves broker + sensors payload.</li>
        <li><code>POST /api/mqtt/poll</code> – connects to the broker, subscribes to all sensor topics, and returns the newest payloads.</li>
      </ul>
      <pre><code>curl -X POST http://localhost:8000/api/mqtt/poll</code></pre>
    </section>

    <section>
      <h2>Tips</h2>
      <ul>
        <li>Use retained MQTT messages or frequent publishes so the poll endpoint returns fresh readings.</li>
        <li>Keep topic names short and descriptive; they become prompt snippets.</li>
        <li>Units are optional but help LLM clarity (e.g., % for humidity, ppm for CO₂, µmol/m²/s for PPFD).</li>
      </ul>
    </section>
  </body>
</html>
