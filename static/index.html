<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>OTTCOUTURE OPENCORE Analyzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: radial-gradient(circle at 20% 20%, rgba(64, 255, 163, 0.08), transparent 45%),
          radial-gradient(circle at 75% 0%, rgba(111, 125, 255, 0.12), transparent 45%), #05060f;
        --panel: rgba(6, 8, 18, 0.9);
        --card: rgba(10, 12, 32, 0.95);
        --text: #f8fbff;
        --muted: rgba(255, 255, 255, 0.75);
        --border: rgba(255, 255, 255, 0.1);
        --accent: #40ffa3;
        --accent-2: #6f7dff;
        font-family: "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      body.theme-light {
        --bg: linear-gradient(145deg, #f2f5fb, #ffffff);
        --panel: #ffffff;
        --card: #f8fbff;
        --text: #081126;
        --muted: rgba(8, 17, 38, 0.65);
        --border: rgba(8, 17, 38, 0.12);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        padding: 2rem clamp(1rem, 3vw, 3rem) 4rem;
      }
      header.hero {
        border-radius: 32px;
        padding: clamp(1.5rem, 3vw, 3rem);
        border: 1px solid var(--border);
        background: linear-gradient(135deg, rgba(10, 12, 30, 0.92), rgba(5, 7, 18, 0.92));
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        align-items: flex-end;
      }
      body.theme-light header.hero {
        background: linear-gradient(135deg, #ffffff, #f1f3fb);
      }
      .hero__info h1 {
        margin: 0 0 0.5rem;
        font-size: clamp(2.1rem, 4vw, 3.6rem);
      }
      .hero__info p {
        margin: 0.4rem 0;
        color: var(--muted);
        line-height: 1.5;
      }
      .hero__actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-left: auto;
      }
      .pill-button,
      .hero__actions a {
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 0.7rem 1.3rem;
        background: rgba(255, 255, 255, 0.06);
        color: inherit;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
      }
      .pill-button.accent {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #020305;
        border: none;
      }
      main {
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      .grid {
        display: grid;
        gap: 1.75rem;
      }
      .main-grid {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .streams-grid {
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      }
      .card {
        border-radius: 28px;
        border: 1px solid var(--border);
        background: var(--card);
        padding: clamp(1.25rem, 2vw, 2rem);
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.35);
      }
      body.theme-light .card {
        box-shadow: none;
      }
      h2 {
        margin-top: 0;
        font-size: 1.35rem;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      label {
        font-weight: 600;
        color: var(--muted);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      textarea,
      select,
      input[type="text"],
      input[type="number"],
      input[type="url"],
      input[type="file"],
      input[type="password"],
      input[type="range"] {
        background: rgba(5, 7, 18, 0.65);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 0.9rem 1rem;
        color: var(--text);
        font-family: inherit;
      }
      body.theme-light textarea,
      body.theme-light select,
      body.theme-light input[type="text"],
      body.theme-light input[type="url"],
      body.theme-light input[type="number"],
      body.theme-light input[type="file"],
      body.theme-light input[type="password"],
      body.theme-light input[type="range"] {
        background: #f3f6ff;
        color: #050713;
      }
      textarea {
        min-height: 140px;
        resize: vertical;
      }
      .dropzone {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 1.25rem;
        text-align: center;
        color: var(--muted);
      }
      .dropzone.dragover {
        border-color: var(--accent);
        background: rgba(64, 255, 163, 0.1);
      }
      .template-grid {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }
      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
      }
      .chip-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .chip {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.06);
        cursor: grab;
        font-size: 0.95rem;
      }
      .chip strong {
        display: block;
        font-size: 0.9rem;
      }
      .preview-item {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 0.6rem;
        text-align: center;
        cursor: zoom-in;
      }
      .preview-item img {
        width: 100%;
        height: 90px;
        object-fit: cover;
        border-radius: 14px;
      }
      .classification-block {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 0.75rem 1rem;
        margin: 1rem 0;
        background: rgba(4, 6, 18, 0.5);
      }
      .classification-block ul {
        margin: 0.5rem 0 0;
        padding-left: 1.2rem;
      }
      .action-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }
      button.primary {
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #05060f;
        font-weight: 600;
        padding: 0.95rem 1.5rem;
        cursor: pointer;
      }
      .tab-bar {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }
      .tab-bar button {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        color: inherit;
        padding: 0.4rem 1rem;
        cursor: pointer;
      }
      .tab-bar button.active {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        border: none;
        color: #05060f;
      }
      #result-display {
        border-radius: 20px;
        border: 1px solid rgba(64, 255, 163, 0.35);
        padding: 1.2rem;
        min-height: 180px;
        background: rgba(4, 6, 15, 0.9);
      }
      body.theme-light #result-display {
        background: #f7f8ff;
        color: #050713;
      }
      #result-json {
        border-radius: 18px;
        border: 1px solid var(--border);
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(5, 7, 18, 0.9);
        font-family: "Space Mono", monospace;
        max-height: 280px;
        overflow: auto;
        font-size: 0.85rem;
      }
      .debug-panel {
        margin-top: 1rem;
        border-radius: 16px;
        border: 1px dashed rgba(255, 255, 255, 0.3);
        padding: 1rem;
        display: none;
        font-size: 0.9rem;
      }
      .debug-panel.active {
        display: block;
      }
      .stream-card form small {
        color: var(--muted);
      }
      .stream-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 480px;
        overflow: auto;
      }
      .stream-item {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 1rem;
        background: rgba(8, 10, 22, 0.85);
      }
      .stream-item header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .stream-item footer {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .stream-item footer button {
        border-radius: 12px;
        border: 1px solid var(--border);
        background: transparent;
        color: inherit;
        padding: 0.35rem 0.9rem;
        cursor: pointer;
      }
      .stream-overlay {
        margin: 0.6rem 0 0.25rem;
      }
      .stream-overlay img {
        max-width: 100%;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .disclaimer {
        color: var(--muted);
        font-size: 0.95rem;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 3, 10, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
      }
      .overlay.hidden {
        display: none;
      }
      .modal-card {
        background: var(--panel);
        border-radius: 28px;
        border: 1px solid var(--border);
        padding: 2rem;
        width: min(720px, 92%);
        color: var(--text);
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      #jsonFullscreenOutput {
        max-height: 70vh;
        overflow: auto;
        font-family: "Space Mono", monospace;
      }
      .toast {
        position: fixed;
        right: 1.5rem;
        bottom: 1.5rem;
        padding: 0.85rem 1.1rem;
        background: rgba(2, 3, 10, 0.95);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: none;
        z-index: 99;
      }
      .toast.active {
        display: block;
      }
      footer {
        text-align: center;
        color: var(--muted);
        font-size: 0.9rem;
      }
      footer a {
        color: var(--accent);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <header class="hero">
      <div class="hero__info">
          <p style="letter-spacing: 0.18em; text-transform: uppercase; color: var(--accent)">OTTCOUTURE.EU · OPENCORE</p>
          <h1>OPENCORE Analyzer Control Board</h1>
          <p>
            The analyzer separates Teachable Machine inference from LLM reasoning. Choose pure ML signals, the hybrid stack, or
            stream automation. All rights stay with ottcouture.eu – feedback is welcome via otcdmin@outlook.com, Instagram
            @ottcouture.eu, or Discord
            <a href="https://discord.gg/GMMSqePfPh" target="_blank" rel="noopener">discord.gg/GMMSqePfPh</a>.
          </p>
          <p class="disclaimer">
            Note: the free OPENCORE stack is intended only for private individuals and developer testing. Cannabis Social Clubs
            (CSCs) and companies must obtain a license from ottcouture.eu (otcdmin@outlook.com) before any commercial use.
          </p>
      </div>
      <div class="hero__actions">
        <button class="pill-button" id="themeToggle">Light/Dark</button>
        <button class="pill-button" id="apiSettingsBtn">API-Token-Mode</button>
          <a class="pill-button" href="/doc/index.html" target="_blank" rel="noopener">Docs</a>
          <a class="pill-button" href="/config">Config Hub</a>
          <a class="pill-button" href="/completions">OTTO Chat</a>
        </div>
      </header>

    <main>
      <section class="grid main-grid">
        <article class="card card--prompt" style="grid-column: span 2; min-width: 320px">
            <h2>Manual Analyzer</h2>
            <p class="disclaimer">
              Pick a model, prompt, and analysis mode (ML-only or Hybrid). Templates can be saved locally and reused.
            </p>
          <form id="analyze-form">
            <label>
                Analysis mode
                <select id="analysisMode">
                  <option value="hybrid">Hybrid (TM + GPT)</option>
                  <option value="ml">Teachable Machine only</option>
                  <option value="llm">LLM vision only</option>
                </select>
                <small id="analysisHint">Hybrid requires a prompt.</small>
              </label>
              <label>
                LLM profile
                <select id="llmProfileSelect">
                  <option value="">Use active server profile</option>
                </select>
                <small>Create profiles in the config hub and pick one per run here.</small>
              </label>
              <label>
                Prompt template
                <select id="template-select">
                  <option value="">Select template …</option>
                </select>
              </label>
              <div class="action-row" style="justify-content: space-between">
                <button class="pill-button" type="button" id="saveTemplateBtn">Save prompt as template</button>
                <label class="action-row" style="gap: 0.4rem">
                  <input type="checkbox" id="debugToggle" /> Show debug
                </label>
              </div>
              <div id="customTemplateList" class="template-grid"></div>
              <label>
                Prompt
                <textarea id="prompt" placeholder="Describe the focus"></textarea>
              </label>
              <label>
                Teachable Machine model
                <select id="model-select">
                  <option value="">Loading models …</option>
                </select>
                <small id="model-status">OPENCORE uses the default model when no selection is made.</small>
              </label>
              <div class="classification-block" id="mlDebugLog" style="display: none">
                <strong>ML debug</strong>
                <pre id="mlDebugLogText">Initializing models …</pre>
              </div>
              <label>
                Images
                <input id="image" type="file" accept="image/*" multiple />
                <small id="fileStatus">Select multiple files or drop them below.</small>
              </label>
              <div id="dropzone" class="dropzone">Drop files here or use the picker above.</div>
              <div class="action-row">
                <button class="primary" type="submit" id="analyzeBtn">Run analysis</button>
                <span id="runStatus" class="disclaimer">Ready.</span>
              </div>
            </form>
          </article>

          <article class="card">
            <h2>MQTT sensors & prompt blocks</h2>
            <p class="disclaimer">
              Pull live tent metrics from your MQTT broker and drag values into the prompt for context-aware analyses.
            </p>
            <div class="action-row" style="justify-content: space-between; gap: 0.75rem">
              <button class="secondary" type="button" id="refreshSensors">Refresh sensor values</button>
              <small id="sensorStatus">Waiting for broker config …</small>
            </div>
            <div id="sensorChipContainer" class="chip-grid"></div>
          </article>

          <article class="card card--upload">
            <h2>Preview</h2>
            <p class="disclaimer">Click thumbnails to zoom and inspect details.</p>
            <div id="imagePreviewContainer" class="preview-grid"></div>
          </article>

        <article class="card card--result" style="grid-column: span 2; min-width: 320px">
          <div class="action-row" style="justify-content: space-between; align-items: flex-start">
              <div>
                <h2>Result-Console</h2>
                <p class="disclaimer">Tabs show the overall report and each image; JSON stays raw and downloadable.</p>
              </div>
              <div class="action-row" style="gap: 0.5rem">
                <button type="button" class="pill-button" id="jsonFullscreenBtn">Fullscreen</button>
              <button type="button" class="pill-button" id="jsonDownloadBtn">JSON</button>
              <button type="button" class="pill-button" id="pdfExportBtn">PDF</button>
              <button type="button" class="pill-button" id="shareBtn">Share</button>
            </div>
          </div>
          <div id="result-tabs" class="tab-bar"></div>
            <div id="result-display">
              <p class="disclaimer">No analysis run yet.</p>
            </div>
            <pre id="result-json">{ "status": "ready" }</pre>
            <div id="debugPanel" class="debug-panel"></div>
          </article>

          <article class="card">
            <h2>Video Analyzer</h2>
            <p class="disclaimer">
              Upload MP4 clips or pick an existing recording. Frames are sampled, overlaid, and summarized using ML, LLM-only,
              or the hybrid stack.
            </p>
            <label>
              Video file
              <input id="videoInput" type="file" accept="video/*" />
            </label>
            <label>
              Or choose from library
              <select id="videoUploadSelect">
                <option value="">Use uploaded video …</option>
              </select>
            </label>
            <label>
              Analysis mode
              <select id="videoAnalysisMode">
                <option value="hybrid">Hybrid (TM + GPT)</option>
                <option value="ml">ML only</option>
                <option value="llm">LLM only</option>
              </select>
            </label>
            <label>
              LLM profile
              <select id="videoLlmProfile">
                <option value="">Use active server profile</option>
              </select>
            </label>
            <label>
              Prompt
              <textarea id="videoPrompt" placeholder="Hybrid or LLM-only prompt"></textarea>
            </label>
            <div class="action-row" style="align-items: center; gap: 0.5rem">
              <button type="button" class="primary" id="analyzeVideoBtn">Analyze video</button>
              <span id="videoStatus" class="disclaimer">Ready.</span>
            </div>
            <video id="videoOverlayPreview" style="width: 100%; border-radius: 12px; margin-top: 0.5rem" controls></video>
          </article>

          <article class="card">
            <h2>Upload library</h2>
            <p class="disclaimer">Manage uploaded images, videos, and stream captures. Rename, delete, or trigger analyses.</p>
            <label>
              Upload media
              <input id="libraryInput" type="file" multiple accept="image/*,video/*" />
            </label>
            <div class="action-row" style="gap: 0.5rem">
              <button type="button" class="pill-button" id="libraryUploadBtn">Upload</button>
              <label style="flex: 1">
                Sort
                <select id="uploadSort">
                  <option value="recent">Newest</option>
                  <option value="name">Name</option>
                  <option value="type">Type</option>
                </select>
              </label>
            </div>
            <div id="uploadList" class="upload-list"></div>
          </article>

          <article class="card card--insights">
            <h2>Ops & Notes</h2>
            <p class="disclaimer">
              OPENCORE delivers structured telemetry for enterprise workflows. Documentation for templates, batch, debug, token mode,
              UI shortcuts, export, stream automation, Raspberry Pi deployments, and custom model builds lives at
              <a href="/doc/index.html" target="_blank" rel="noopener">/doc</a>.
            </p>
            <p class="disclaimer">
              Support & rights: ottcouture.eu · otcdmin@outlook.com · Instagram @ottcouture.eu · Discord
              <a href="https://discord.gg/GMMSqePfPh" target="_blank" rel="noopener">discord.gg/GMMSqePfPh</a>.
            </p>
          </article>
      </section>

      <section class="grid streams-grid">
        <article class="card stream-card">
            <h2>Stream Orchestration</h2>
            <p class="disclaimer">
              Streams pull frames every 5 seconds (configurable) from snapshot or video sources, collect batch images, and trigger
              ML-only or hybrid evaluations automatically—ideal for tent cams or Raspberry Pi edge nodes.
            </p>
            <form id="streamForm">
              <label>
                Name
                <input type="text" id="streamName" placeholder="e.g., Tent North" />
              </label>
              <label>
                Source (URL, RTSP, file, or USB index)
                <input type="text" id="streamUrl" placeholder="http://cam/snapshot.jpg or 0" required />
              </label>
              <label>
                Source type
                <select id="streamSourceType">
                  <option value="snapshot">Snapshot (HTTP/JPEG)</option>
                  <option value="video">Video (RTSP/Datei)</option>
                  <option value="usb">USB webcam</option>
                </select>
              </label>
              <label>
                Analysis mode
                <select id="streamAnalysisMode">
                  <option value="hybrid">Hybrid</option>
                  <option value="ml">ML only</option>
                  <option value="llm">LLM only</option>
                </select>
              </label>
              <label>
                LLM profile
                <select id="streamLlmProfile">
                  <option value="">Use active server profile</option>
                </select>
                <small>Selection applies only to this stream run.</small>
              </label>
              <label>
                Prompt for hybrid mode
                <textarea id="streamPrompt" placeholder="Only needed when hybrid is enabled."></textarea>
              </label>
              <label>
                Model
                <select id="streamModel">
                  <option value="">Loading models …</option>
                </select>
              </label>
              <div class="action-row">
                <label style="flex: 1">
                  Capture interval (sec)
                  <input type="number" id="streamCaptureInterval" min="1" value="5" />
                </label>
                <label style="flex: 1">
                  Analysis interval (sec)
                  <input type="number" id="streamBatchInterval" min="5" value="30" />
                </label>
              </div>
              <button class="primary" type="submit">Start stream</button>
            </form>
          </article>
          <article class="card">
            <div class="action-row" style="justify-content: space-between">
              <h2>Active streams</h2>
              <div class="action-row" style="gap: 0.5rem">
                <button class="pill-button" type="button" id="streamRefresh">Refresh</button>
              </div>
            </div>
            <p id="streamStatus" class="disclaimer">No streams registered yet.</p>
            <div id="streamList" class="stream-list"></div>
          </article>
        </section>
      </main>

      <footer>
        OPENCORE Analyzer – enterprise tooling from ottcouture.eu · Documentation, tutorials, and hardware guides live at
        <a href="/doc/index.html" target="_blank" rel="noopener">/doc</a>.
      </footer>

      <div class="overlay hidden" id="templateModal">
        <div class="modal-card">
          <h3>Save custom template</h3>
          <label>
            Title
            <input type="text" id="templateName" placeholder="e.g., QC run" />
          </label>
          <label>
            Description
            <textarea id="templateDescription" placeholder="Internal note"></textarea>
          </label>
          <div class="modal-actions">
            <button class="pill-button" type="button" id="cancelTemplate">Cancel</button>
            <button class="pill-button accent" type="button" id="confirmTemplate">Save</button>
          </div>
        </div>
      </div>

    <div class="overlay hidden" id="apiModal">
      <div class="modal-card">
          <h3>API token mode</h3>
          <label>
            API Base URL
            <input type="text" id="apiBaseUrl" placeholder="https://partner.tld/api" />
        </label>
        <label>
            API Token
            <input type="password" id="apiToken" placeholder="Bearer Token" />
          </label>
          <label class="action-row" style="gap: 0.5rem">
            <input type="checkbox" id="apiModeEnabled" /> Enable API token mode
          </label>
          <p class="disclaimer">
            Settings are stored locally only. When enabled, the UI sends all requests to the base URL and adds the Authorization header
            automatically.
          </p>
          <h4>Code examples</h4>
          <pre><code>curl -X POST "$BASE/api/opencore/analyze" \
    -H "Authorization: Bearer $TOKEN" \
    -F "prompt=Bag Appeal" -F "image=@bud.jpg"

python requests.post(
  f"{base}/api/opencore/analyze",
  headers={"Authorization": f"Bearer {token}"},
  files={"image": open("bud.jpg", "rb")},
  data={"prompt": "Trichome"}
  )</code></pre>
          <div class="modal-actions">
            <button class="pill-button" type="button" id="resetApiSettings">Reset</button>
            <button class="pill-button" type="button" id="closeApiModal">Close</button>
            <button class="pill-button accent" type="button" id="saveApiSettings">Save</button>
          </div>
        </div>
      </div>

    <div class="overlay hidden" id="imageModal">
      <div class="modal-card" style="max-width: 900px">
            <h3 style="display: flex; justify-content: space-between; align-items: center">
            Image preview
            <button class="pill-button" type="button" id="closeImageModal">Close</button>
          </h3>
        <div style="text-align: center">
          <img id="modalImage" src="" alt="Preview" style="max-width: 100%; border-radius: 16px" />
        </div>
        <label style="margin-top: 1rem">
            Zoom
            <input type="range" id="zoomSlider" min="50" max="150" value="100" />
          </label>
        </div>
      </div>

      <div class="overlay hidden" id="jsonFullscreen">
        <div class="modal-card" style="max-width: 960px">
          <h3 style="display: flex; justify-content: space-between; align-items: center">
            JSON fullscreen
            <button class="pill-button" type="button" id="closeJsonFullscreen">Close</button>
          </h3>
          <pre id="jsonFullscreenOutput"></pre>
        </div>
      </div>

    <div class="toast" id="toast"></div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
      integrity="sha512-/pC24t2EBhJ7ezCmvYzu3/n6PvJEa3TBUnIFVWMGryuVKyXjH9MuquMNFc13JUO2c+hJ1ytY1/6Yr2vNhbbXnw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="/static/js/app.js" defer></script>
  </body>
</html>
